name: Build on version bump

on:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    package-windows:
        name: Build and Package on Windows
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - name: Get version from package.json
              id: package-version
              run: |
                  $ver = (Get-Content package.json | ConvertFrom-Json).version
                  echo "version=$ver" >> $env:GITHUB_OUTPUT
                  Write-Host "Current version: $ver"

            - name: Install dependencies
              run: npm ci

            - name: Make (windows)
              run: npm run make

            - name: Prepare portable zip
              run: |
                  $ver = '${{ steps.package-version.outputs.version }}'
                  $appdir = 'out\Snowverlay-win32-x64'
                  if (Test-Path $appdir) {
                    $zip = "out\Snowverlay-$ver-portable.zip"
                    if (Test-Path $zip) { Remove-Item $zip -Force }
                    Compress-Archive -Path (Join-Path $appdir '*') -DestinationPath $zip -Force
                    Write-Host "Created portable zip: $zip"
                  } else {
                    Write-Host 'No unpacked app directory found'
                  }

            - name: Upload Setup.exe
              uses: actions/upload-artifact@v4
              with:
                  name: Snowverlay-${{ steps.package-version.outputs.version }}-Setup
                  path: out/make/squirrel.windows/x64/*Setup.exe
                  if-no-files-found: warn

            - name: Upload nupkg
              uses: actions/upload-artifact@v4
              with:
                  name: Snowverlay-${{ steps.package-version.outputs.version }}-nupkg
                  path: out/make/squirrel.windows/x64/*full.nupkg
                  if-no-files-found: warn

            - name: Upload portable zip
              uses: actions/upload-artifact@v4
              with:
                  name: Snowverlay-${{ steps.package-version.outputs.version }}-portable
                  path: out/Snowverlay-${{ steps.package-version.outputs.version }}-portable.zip
                  if-no-files-found: warn
